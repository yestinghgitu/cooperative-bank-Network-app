/***************************************
 India Cooperative Visit Tracker - Apps Script
 Paste into Extensions → Apps Script for your Google Sheet
 ***************************************/

/* =================== CONFIGURATION =================== */
// Edit these before use:
const CONFIG = {
  VISITS_SHEET_NAME: "Visits",         // main sheet where data lands
  STATE_SHEET_PREFIX: "",             // prefix for created state sheets (optional)
  EMAIL_RECIPIENTS: ["youremail@domain.com"], // array of emails to receive reminders/alerts
  REMINDER_DAYS_AHEAD: 1,             // how many days ahead to remind (1 = tomorrow)
  TIMEZONE: "Asia/Kolkata",           // use your timezone
  CREATE_STATE_SHEETS: true,          // set false if you already created state sheets
  PROTECT_STATE_SHEETS: false         // protection requires domain-level accounts; leave false unless using Workspace
};

/* Master header row - must match exactly the Visits sheet headers */
const HEADERS = [
  "State", "Division/Region", "District", "Taluk/Block", "Employee Name", "Employee ID",
  "Date of Visit", "Co-operative Society / Bank Name", "Type (Society/Bank)",
  "Address", "Contact Person", "Contact Number", "Purpose of Visit",
  "Discussion Summary", "Documents Collected", "Next Follow-up Date",
  "Status (Pending/Completed)", "Remarks"
];

/* Official list of Indian States/UTs used when creating form/state sheets */
const STATES = [
  "Andhra Pradesh","Arunachal Pradesh","Assam","Bihar","Chhattisgarh","Goa","Gujarat",
  "Haryana","Himachal Pradesh","Jharkhand","Karnataka","Kerala","Madhya Pradesh",
  "Maharashtra","Manipur","Meghalaya","Mizoram","Nagaland","Odisha","Punjab",
  "Rajasthan","Sikkim","Tamil Nadu","Telangana","Tripura","Uttar Pradesh",
  "Uttarakhand","West Bengal","Delhi","Puducherry","Jammu & Kashmir","Ladakh"
];

/* =================== UTILITIES =================== */
function getSheetByNameSafe(name) {
  const ss = SpreadsheetApp.getActive();
  let sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
  }
  return sheet;
}

function findHeaderIndex(sheet, headerName) {
  const headers = sheet.getRange(1,1,1,sheet.getLastColumn()).getValues()[0];
  for (let i=0;i<headers.length;i++) {
    if (String(headers[i]).trim() === headerName) return i+1; // 1-based
  }
  return -1;
}

/* =================== SETUP HELPERS =================== */

/**
 * createStateSheets()
 * Create sheets for all STATES with the standard headers in row 1.
 * Run once to create the state sheets.
 */
function createStateSheets() {
  const ss = SpreadsheetApp.getActive();
  if (!CONFIG.CREATE_STATE_SHEETS) {
    Logger.log("CONFIG.CREATE_STATE_SHEETS is false — skipping creation.");
    return;
  }
  STATES.forEach(function(st) {
    const sheetName = (CONFIG.STATE_SHEET_PREFIX || "") + st;
    if (!ss.getSheetByName(sheetName)) {
      const sht = ss.insertSheet(sheetName);
      sht.setTabColor("#d9eaf7");
      // write headers
      sht.getRange(1,1,1,HEADERS.length).setValues([HEADERS]);
      // small instruction note
      sht.getRange(2,1).setValue("This sheet is for reference. Use FILTER in Google Sheets to auto-populate, or rely on the autoCopyToStateSheets function.");
    } else {
      Logger.log("Sheet exists: " + sheetName);
    }
  });
  // Optionally protect sheets (Workspace only)
  if (CONFIG.PROTECT_STATE_SHEETS) {
    protectStateSheets();
  }
}

/**
 * protectStateSheets() - optional, only works well on Google Workspace domains.
 * You will need to edit allowed editors below; by default it protects for owner only.
 */
function protectStateSheets() {
  const ss = SpreadsheetApp.getActive();
  const me = Session.getEffectiveUser().getEmail();
  STATES.forEach(function(st) {
    const sheetName = (CONFIG.STATE_SHEET_PREFIX || "") + st;
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) return;
    const protection = sheet.protect().setDescription("Protected sheet for " + st);
    protection.removeEditors(protection.getEditors());
    // Allow the owner (you) to edit:
    protection.addEditor(me);
    if (protection.canDomainEdit()) protection.setDomainEdit(false);
  });
}

/* =================== FORM CREATION =================== */

/**
 * createLinkedForm()
 * Creates a Google Form and links responses to this spreadsheet.
 * Run once. It will create a Form and set its destination to this spreadsheet.
 */
function createLinkedForm() {
  const ss = SpreadsheetApp.getActive();
  const form = FormApp.create(ss.getName() + " - Visit Entry Form");
  form.setDescription("Use this form to submit Co-operative / Bank visit details.");
  // Build form from HEADERS
  HEADERS.forEach(function(h) {
    if (h.indexOf("Date") !== -1) {
      form.addDateItem().setTitle(h);
    } else if (h.indexOf("Contact Number") !== -1) {
      form.addTextItem().setTitle(h).setHelpText("Enter phone or WhatsApp number");
    } else if (h.indexOf("Status") !== -1) {
      form.addMultipleChoiceItem().setTitle(h).setChoiceValues(["Pending","Completed"]).showOtherOption(false);
    } else if (h.indexOf("Type") !== -1) {
      form.addMultipleChoiceItem().setTitle(h).setChoiceValues(["Co-operative Society","Urban Co-operative Bank","Credit Cooperative","Other"]).showOtherOption(true);
    } else if (h === "State") {
      const item = form.addListItem();
      item.setTitle("State").setChoiceValues(STATES);
    } else {
      form.addTextItem().setTitle(h);
    }
  });
  // Link the form to the spreadsheet (will create a new sheet 'Form Responses 1')
  form.setDestination(FormApp.DestinationType.SPREADSHEET, ss.getId());
  SpreadsheetApp.getUi().alert("Form created and linked. Form URL: " + form.getEditUrl());
  Logger.log("Form created: " + form.getEditUrl());
}

/* =================== ON FORM SUBMIT =================== */

/**
 * onFormSubmit(e)
 * If using Google Form responses, set default values and normalize incoming rows.
 * Install via Trigger: From spreadsheet -> On form submit
 */
function onFormSubmit(e) {
  try {
    const ss = SpreadsheetApp.getActive();
    const visits = ss.getSheetByName(CONFIG.VISITS_SHEET_NAME);
    if (!visits) return;
    // If form responses are going to a Responses sheet, copy last row into Visits
    // Many users link form responses to the spreadsheet and want data in Visits sheet.
    // Here we try to be flexible: find the form responses sheet via e.source and move row.
    if (!e) return;
    const respSheet = e.range.getSheet();
    const respRangeRow = e.range.getRow();
    const respValues = respSheet.getRange(respRangeRow,1,1,respSheet.getLastColumn()).getValues()[0];

    // Map form responses to Visits columns — simple approach: append values in order
    // If form was built exactly from HEADERS, we can append directly:
    visits.appendRow(respValues);
    // Ensure Status is set
    const statusIdx = findHeaderIndex(visits, "Status (Pending/Completed)");
    const lastRow = visits.getLastRow();
    if (statusIdx > 0) {
      const stCell = visits.getRange(lastRow, statusIdx);
      if (!stCell.getValue()) stCell.setValue("Pending");
    }
  } catch (err) {
    Logger.log("onFormSubmit error: " + err);
  }
}

/* =================== AUTO COPY TO STATE SHEETS =================== */

/**
 * autoCopyToStateSheets(e)
 * Copies newly added rows in Visits to their State sheet.
 * Install as On change (or run programmatically). This avoids FILTER() if you prefer copies.
 * NOTE: keep idempotency in mind; this checks for a marker column to avoid duplicate copies.
 */
function autoCopyToStateSheets(e) {
  const ss = SpreadsheetApp.getActive();
  const visits = ss.getSheetByName(CONFIG.VISITS_SHEET_NAME);
  if (!visits) return;
  const dataRange = visits.getDataRange();
  const data = dataRange.getValues();
  const header = data[0];
  const stateIdx = header.indexOf("State");
  if (stateIdx < 0) return;

  // We'll use an internal helper column "CopiedToState" at the far right to mark processed rows
  const copyFlagHeader = "CopiedToState";
  let copyFlagIdx = header.indexOf(copyFlagHeader);
  if (copyFlagIdx === -1) {
    // create flag column
    visits.getRange(1, header.length+1).setValue(copyFlagHeader);
    copyFlagIdx = header.length; // zero-based index
  }

  // Refresh data and header length after potential change
  const lastCol = visits.getLastColumn();
  const newData = visits.getRange(2,1,visits.getLastRow()-1,lastCol).getValues();

  newData.forEach(function(row, i) {
    const state = row[stateIdx];
    const copiedFlag = row[copyFlagIdx] || "";
    if (state && copiedFlag !== "YES") {
      // find target sheet
      const targetName = (CONFIG.STATE_SHEET_PREFIX || "") + String(state);
      let target = ss.getSheetByName(targetName);
      if (!target) {
        // Create if missing (optional)
        target = ss.insertSheet(targetName);
        target.getRange(1,1,1,HEADERS.length).setValues([HEADERS]);
      }
      // Append the row (only the number of header columns)
      const rowToWrite = row.slice(0, HEADERS.length);
      target.appendRow(rowToWrite);
      // Mark as copied
      const sheetRow = i + 2; // data rows start at row 2
      visits.getRange(sheetRow, copyFlagIdx+1).setValue("YES");
    }
  });
}

/* =================== DAILY FOLLOW-UP REMINDERS =================== */

/**
 * dailyFollowUpReminder()
 * Scans Visits sheet and emails reminders for follow-ups due within REMINDER_DAYS_AHEAD or overdue
 * Install as Time-driven trigger (daily).
 */
function dailyFollowUpReminder() {
  const ss = SpreadsheetApp.getActive();
  const visits = ss.getSheetByName(CONFIG.VISITS_SHEET_NAME);
  if (!visits) return;
  const data = visits.getDataRange().getValues();
  if (data.length < 2) return;
  const headers = data[0];
  const nextFollowIdx = headers.indexOf("Next Follow-up Date");
  const statusIdx = headers.indexOf("Status (Pending/Completed)");
  const empIdx = headers.indexOf("Employee Name");
  const districtIdx = headers.indexOf("District");
  const socIdx = headers.indexOf("Co-operative Society / Bank Name");
  if (nextFollowIdx < 0 || statusIdx < 0) return;

  const today = new Date();
  const lines = [];
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const nextDate = row[nextFollowIdx];
    const status = row[statusIdx];
    if (nextDate instanceof Date && status === "Pending") {
      // date-only comparison
      const nd = new Date(nextDate.getFullYear(), nextDate.getMonth(), nextDate.getDate());
      const td = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const daysDiff = Math.round((nd - td)/(1000*60*60*24));
      if (daysDiff <= CONFIG.REMINDER_DAYS_AHEAD) {
        lines.push("Employee: " + (row[empIdx] || "") + " | District: " + (row[districtIdx] || "") +
                   " | Society: " + (row[socIdx] || "") + " | Next Follow-up: " + nextDate.toLocaleDateString());
      }
    }
  }

  if (lines.length > 0) {
    const subject = "Visit follow-up reminders (due soon or overdue)";
    const body = lines.join("\n\n");
    // send to configured recipients
    CONFIG.EMAIL_RECIPIENTS.forEach(function(email) {
      MailApp.sendEmail(email, subject, body);
    });
  }
}

/* =================== STATUS CHANGE ALERT =================== */

/**
 * statusChangeAlert(e)
 * Installable onEdit trigger recommended.
 * When the Status column for a row becomes "Completed", an email is sent.
 */
function statusChangeAlert(e) {
  try {
    const ss = SpreadsheetApp.getActive();
    const sheet = ss.getSheetByName(CONFIG.VISITS_SHEET_NAME);
    if (!sheet || !e) return;
    if (e.range.getSheet().getName() !== CONFIG.VISITS_SHEET_NAME) return;
    const headers = sheet.getRange(1,1,1,sheet.getLastColumn()).getValues()[0];
    const statusCol = headers.indexOf("Status (Pending/Completed)") + 1;
    if (statusCol < 1) return;
    const row = e.range.getRow();
    if (e.range.getColumn() === statusCol && row > 1) {
      const newVal = e.range.getValue();
      if (newVal === "Completed") {
        const employee = sheet.getRange(row, headers.indexOf("Employee Name")+1).getValue();
        const contact = sheet.getRange(row, headers.indexOf("Contact Number")+1).getValue();
        const soc = sheet.getRange(row, headers.indexOf("Co-operative Society / Bank Name")+1).getValue();
        const subject = "Visit completed: " + soc;
        const body = "Employee: " + employee + "\nContact: " + contact + "\nSoc/Bank: " + soc + "\nRow: " + row;
        CONFIG.EMAIL_RECIPIENTS.forEach(function(email) {
          MailApp.sendEmail(email, subject, body);
        });
      }
    }
  } catch (err) {
    Logger.log("statusChangeAlert error: " + err);
  }
}

/* =================== MIGRATION HELPER =================== */

/**
 * importFormResponsesToVisits()
 * If form responses are in a separate sheet "Form Responses 1", this function copies them over to Visits
 * Run once if needed to migrate historical responses.
 */
function importFormResponsesToVisits() {
  const ss = SpreadsheetApp.getActive();
  const respSheet = ss.getSheetByName("Form Responses 1");
  const visits = getSheetByNameSafe(CONFIG.VISITS_SHEET_NAME);
  if (!respSheet) return;
  const data = respSheet.getDataRange().getValues();
  // Assumes headers match; skip header row
  for (let i = 1; i < data.length; i++) {
    visits.appendRow(data[i]);
  }
  // Optionally clear respSheet after copy
  // respSheet.clearContents();
}

/* =================== END OF SCRIPT =================== */


<!DOCTYPE html>
<html>
<head>
<base target="_top">
<style>
  body { font-family:'Segoe UI',sans-serif;background:#f4f7f9; }
  .container { max-width:900px;margin:50px auto;background:white;padding:25px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1); }
  h2,h3,h4 { color:#333;text-align:center; }
  label { display:block; margin-top:10px; font-weight:bold; }
  input, select, textarea, button { width:100%; margin:5px 0; padding:8px; border-radius:5px; border:1px solid #ccc; box-sizing:border-box; }
  textarea { resize: vertical; }
  button { background:#4285f4; color:white; font-weight:bold; border:none; cursor:pointer; }
  button:hover { background:#3367d6; }
  #formSection { margin-top:20px; }
  table { width:100%; border-collapse: collapse; margin-top:20px; font-size:14px; }
  table, th, td { border:1px solid #ccc; }
  th, td { padding:6px; text-align:left; }
  th { background:#f4f7f9; }
  #visitsTableContainer { overflow-x:auto; }
  .filterContainer { margin-top:20px; }
  .filterContainer input { width:auto; display:inline-block; margin-right:10px; }
  .filterContainer button { width:auto; display:inline-block; padding:5px 15px; margin-left:5px; }
</style>
<script>
let allowedUsers = {}; // {email: {name, code, role}}
let currentUserEmail = "";
let currentUserName = "";
let currentUserCode = "";

// Example division/district data
const divisionData = {
  "Karnataka": {
    "Bengaluru Division": ["Bengaluru Urban","Bengaluru Rural","Chikkaballapura","Chitradurga","Davanagere","Kolar","Ramanagara","Shivamogga","Tumakuru"],
    "Mysuru Division": ["Chamarajanagar","Chikkamagaluru","Dakshina Kannada","Hassan","Kodagu","Mandya","Mysuru","Udupi"],
    "Belagavi Division": ["Bagalkote","Belagavi","Dharwad","Gadag","Haveri","Uttara Kannada"],
    "Kalaburagi Division": ["Ballari","Bidar","Kalaburagi","Koppal","Raichur","Vijayapura","Yadgir"]
  }
};
let locData = {}; // other states/districts

// -------------------------
// Initialize Portal
// -------------------------
// -------------------------
// Initialize Login Portal
// -------------------------
function initPortal(){
  document.getElementById("loginSection").style.display = "block"; // Show login immediately (optional)
}

// -------------------------
// Manual Login
// -------------------------
function manualLogin(){
  const emailInput = document.getElementById("email").value.trim().toLowerCase();
  if(!emailInput){
    alert("Please enter your registered email.");
    return;
  }

  // Call server-side function to get employee by email
  google.script.run.withSuccessHandler(function(employee){
    if(!employee){
      alert("Unauthorized: Only registered users can log in.");
      return;
    }

    // Set current user info
    currentUserEmail = emailInput;
    currentUserName = employee.name;
    currentUserCode = employee.code || "";
    showForm();
  }).getEmployeeByEmail(emailInput);
}


// -------------------------
// Show Form
// -------------------------
function showForm(){
  document.getElementById("loginSection").style.display="none";
  const portal = document.getElementById("portal");
  portal.innerHTML = `
      <div id="formSection">
        <h3>Submit Visit Data</h3>
        <form id="visitForm" onsubmit="submitData(); return false;">
          <label>State:</label>
          <select id="state" required onchange="onStateChange()"><option value="">Loading...</option></select>

          <label id="division_label" style="display:none;">Division / Region:</label>
          <select id="division" style="display:none;" onchange="populateDistrictsFromDivision()"></select>

          <label>District:</label>
          <select id="district" required><option value="">Select state first</option></select>

          <label>Taluk / Block:</label>
          <input type="text" id="taluk" placeholder="Enter Taluk / Block">

          <label>Employee Name:</label>
          <input type="text" id="employeeName" value="${currentUserName}" readonly>

          <label>Employee Code:</label>
          <input type="text" id="employeeCode" value="${currentUserCode}" readonly>

          <label>Date of Visit:</label>
          <input type="date" id="date" required>

          <label>Co-operative Society / Bank Name:</label>
          <input type="text" id="societyName" required placeholder="Enter Society or Bank name">

          <label>Type (Society/Bank):</label>
          <select id="type" required>
            <option>Co-operative Society</option>
            <option>Urban Co-operative Bank</option>
            <option>Credit Cooperative</option>
            <option>Other</option>
          </select>

          <label>Address:</label>
          <input type="text" id="address">

          <label>Contact Person:</label>
          <input type="text" id="contactPerson">

          <label>Contact Number:</label>
          <input type="text" id="contactNumber" placeholder="Phone or WhatsApp number">

          <label>Purpose of Visit:</label>
          <textarea id="purpose" rows="2"></textarea>

          <label>Discussion Summary:</label>
          <textarea id="summary" rows="3"></textarea>

          <label>Documents Collected:</label>
          <textarea id="documents" rows="2"></textarea>

          <label>Next Follow-up Date:</label>
          <input type="date" id="nextFollow">

          <label>Status (Pending/Completed):</label>
          <select id="status">
            <option>Pending</option>
            <option>Completed</option>
          </select>

          <label>Remarks:</label>
          <textarea id="remarks" rows="2"></textarea>

          <button type="submit">Submit Visit</button>
        </form>
      </div>`;
  loadStates();
}

// -------------------------
// Load States
// -------------------------
function loadStates(){
  google.script.run.withSuccessHandler(function(data){
    locData = data || {};
    const stateSel = document.getElementById("state");
    stateSel.innerHTML = '<option value="">Select state</option>';
    Object.keys(locData).sort().forEach(st => stateSel.add(new Option(st, st)));
  }).getLocationData();
}

// -------------------------
// State & Division Change
// -------------------------
function onStateChange(){
  const state = document.getElementById("state").value;
  if(state==="Karnataka"){ showDivisionDropdown(state); }
  else { hideDivisionDropdown(); populateDistricts(); }
}

function showDivisionDropdown(state){
  const divSel = document.getElementById("division");
  const divLabel = document.getElementById("division_label");
  divSel.style.display="block"; divLabel.style.display="block";
  divSel.innerHTML='<option value="">Select division</option>';
  Object.keys(divisionData[state]).forEach(d=>divSel.add(new Option(d,d)));
  document.getElementById("district").innerHTML='<option value="">Select division first</option>';
}

function hideDivisionDropdown(){
  document.getElementById("division").style.display="none";
  document.getElementById("division_label").style.display="none";
  document.getElementById("division").innerHTML="";
}

function populateDistricts(){
  const state = document.getElementById("state").value;
  const distSel = document.getElementById("district");
  if(state && locData[state]){
    distSel.innerHTML='<option value="">Select district</option>';
    locData[state].sort().forEach(d => distSel.add(new Option(d,d)));
  } else distSel.innerHTML='<option value="">Select state first</option>';
}

function populateDistrictsFromDivision(){
  const state=document.getElementById("state").value;
  const div=document.getElementById("division").value;
  const distSel=document.getElementById("district");
  if(state==="Karnataka" && div && divisionData[state][div]){
    distSel.innerHTML='<option value="">Select district</option>';
    divisionData[state][div].forEach(d=>distSel.add(new Option(d,d)));
  } else populateDistricts();
}

// -------------------------
// Submit Form Data
// -------------------------
function submitData(){
  const btn=document.querySelector("#visitForm button");
  btn.disabled=true;

  const row=[
    document.getElementById("state").value,
    document.getElementById("division").value||"",
    document.getElementById("district").value,
    document.getElementById("taluk").value,
    currentUserName,
    currentUserCode,
    document.getElementById("date").value,
    document.getElementById("societyName").value,
    document.getElementById("type").value,
    document.getElementById("address").value,
    document.getElementById("contactPerson").value,
    document.getElementById("contactNumber").value,
    document.getElementById("purpose").value,
    document.getElementById("summary").value,
    document.getElementById("documents").value,
    document.getElementById("nextFollow").value,
    document.getElementById("status").value||"Pending",
    document.getElementById("remarks").value
  ];

  google.script.run.withSuccessHandler(function(res){
    alert(res ? "Visit submitted successfully!" : "Submission failed!");
    document.getElementById("visitForm").reset();
    btn.disabled=false;
  }).submitVisitData(row);
}

// -------------------------
// On Load
// -------------------------
window.onload = function(){
  initPortal();
};
</script>
</head>
<body>
<div class="container">
<h2>Employee Portal</h2>

<div id="loginSection" style="display:none;">
  <input type="text" id="email" placeholder="Enter your registered email">
  <button onclick="manualLogin()">Login</button>
</div>

<div id="portal"></div>
</div>
</body>
</html>
